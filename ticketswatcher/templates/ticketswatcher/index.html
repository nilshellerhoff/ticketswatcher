{% extends "ticketswatcher/base.html" %}

{% block title %}Concerts{% endblock %}
{% block contenttitle %}Concerts{% endblock %}

{% block content %}
    <div class="py-5">
        <h2>Concerts</h2>
    </div>


    <!-- search field -->
    <div class="input-group mb-3">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="searchField" type="text" class="form-control" placeholder="Search...">
    </div>

    <div id="app">

        <!-- provider selector -->
        <form>
            <providerselector v-for="provider in providers" :provider="provider" :key="provider.id"></providerselector>
        </form>

        <!-- concert list -->
        <ol id="concertList" class="list-group list-group-numbered">
            <concert v-for="concert in concertsFiltered" :concert="concert" :key="concert.pk"></concert>
        </ol>

        <!-- end app -->
    </div>

    <!-- templates -->
    <template id="templateProviderSelector">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" :name="provider.id" :id="provider.id"
                   v-model="provider.selected">
            <label class="form-check-label" :for="provider.id">
                [[ provider.title ]]
            </label>
        </div>
    </template>

    <template id="templateConcertBlock">
        <a :href="`/concert/${concert.pk}`" class="text-decoration-none">
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    [[ concert.fields.providerHR ]]
                    <div class="fw-bold">[[ concert.fields.title ]]</div>
                    [[ concert.fields.datestr ]] / [[ concert.fields.venue ]]
                </div>
                <span class="badge bg-primary rounded-pill">14</span>
            </li>
        </a>
    </template>

    <script>
        Vue.component('concert', {
            delimiters: ['[[', ']]'],
            template: '#templateConcertBlock',
            props: ['concert'],
        });

        Vue.component('providerselector', {
            delimiters: ['[[', ']]'],
            template: '#templateProviderSelector',
            props: ['provider'],
        })
    </script>

    <script>
        var app = new Vue({
            el: '#app',
            data: {
                providers: [
                    {
                        id: 1,
                        title: "BRSO",
                        name: "brso",
                        selected: true,
                    },
                    {
                        id: 3,
                        title: "MÃ¼nchner Philharmoniker",
                        name: "mphil",
                        selected: true,
                    },
                    {
                        id: 2,
                        name: "brticket",
                        title: "BR Ticket",
                        selected: false,
                    },
                ],
                concerts: {{ concerts | safe }},
                concertsFiltered: [],
            },
            methods: {
                filterConcerts() {
                    this.concertsFiltered = this.concerts.filter((concert) => {
                        inSearch = concert.fields.title.toLowerCase().includes(document.querySelector('#searchField').value.toLowerCase());
                        inProvider = this.providers.find(provider => provider.name == concert.fields.provider).selected == true;
                        return inSearch && inProvider;
                    });
                }
            },
            watch: {
                providers: {
                    handler: function () {
                        this.filterConcerts();
                    },
                    deep: true,
                },
            },
            mounted() {
                this.filterConcerts();
            },
        });

        $(document).ready(function () {
            document.querySelector('#searchField').value = "";
            $("#searchField").on("keyup", function () {
                app.filterConcerts();
            });
        });

    </script>

{% endblock %}